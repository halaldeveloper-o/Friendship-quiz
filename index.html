<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendship Quiz - Firestore Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0fdf4; }
        .card { border-radius: 1.5rem; transition: all 0.3s ease; }
        .btn-green { background-color: #28a745; color: white; transition: transform 0.2s; }
        .btn-green:active { transform: scale(0.95); }
        .avatar-option { cursor: pointer; border: 4px solid transparent; border-radius: 1rem; transition: 0.2s; }
        .avatar-selected { border-color: #28a745; background-color: #dcfce7; }
        .hidden-section { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-md flex justify-end mb-4">
        <select id="langSwitcher" class="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg shadow-sm focus:outline-none">
            <option value="en">English</option>
            <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        </select>
    </div>

    <main class="w-full max-w-md bg-white shadow-2xl card p-6 animate-fade">
        
        <section id="step1">
            <h1 id="welcomeTitle" class="text-2xl font-bold text-center text-green-700 mb-2">Create Your Friendship Quiz! üêº</h1>
            <p id="welcomeSub" class="text-center text-gray-500 mb-6">See who knows you best!</p>
            <div class="mb-4">
                <label id="labelName" class="block text-sm font-semibold mb-2">Enter Your Name:</label>
                <input type="text" id="userName" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none" placeholder="...">
            </div>
            <label id="labelGender" class="block text-sm font-semibold mb-2 text-center">Select Your Avatar:</label>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="avatar-option p-2 text-center" onclick="selectAvatar('male', this)">
                    <div class="text-4xl">üêº</div>
                    <span class="text-xs font-bold">Male</span>
                </div>
                <div class="avatar-option p-2 text-center" onclick="selectAvatar('female', this)">
                    <div class="text-4xl">üêª</div>
                    <span class="text-xs font-bold">Female</span>
                </div>
                <div class="avatar-option p-2 text-center" onclick="selectAvatar('other', this)">
                    <div class="text-4xl">üê®</div>
                    <span class="text-xs font-bold">Other</span>
                </div>
            </div>
            <button onclick="startQuizCreation()" class="w-full btn-green py-4 rounded-xl font-bold text-lg shadow-lg">Continue ‚Üí</button>
        </section>

        <section id="step2" class="hidden-section">
            <div class="flex justify-between items-center mb-4">
                <span id="qCount" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">Question 0/10</span>
                <span id="creatorNameDisplay" class="font-bold text-gray-700"></span>
            </div>
            <div id="questionContainer" class="min-h-[200px] flex flex-col justify-center text-center">
                <h2 id="currentQuestion" class="text-xl font-bold mb-6"></h2>
                <div id="optionsGrid" class="grid grid-cols-1 gap-3"></div>
            </div>
            <div class="mt-8">
                <button onclick="skipQuestion()" id="skipBtn" class="w-full text-gray-400 font-semibold py-2">Skip this question ‚ûî</button>
            </div>
        </section>

        <section id="step3" class="hidden-section text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 id="readyTitle" class="text-2xl font-bold mb-2">Quiz is Ready!</h2>
            <p id="readySub" class="text-gray-500 mb-6">Share this link with your friends.</p>
            <input type="text" id="shareLink" readonly class="w-full p-3 bg-gray-50 border border-dashed border-green-400 rounded-lg mb-4 text-sm">
            <button onclick="copyLink()" class="w-full btn-green py-4 rounded-xl font-bold mb-4">Copy Link üìã</button>
            <div id="creatorLeaderboard" class="mt-6 text-left border-t pt-4">
                <h3 id="scoresTitle" class="font-bold text-gray-700 mb-2">Recent Scores:</h3>
                <div id="leaderboardEntries" class="space-y-2 text-sm"></div>
            </div>
        </section>

        <section id="step4" class="hidden-section">
            <div class="text-center mb-6">
                <div id="friendAvatar" class="text-5xl mb-2">üêº</div>
                <h2 id="friendWelcome" class="text-xl font-bold text-green-700">How well do you know Alex?</h2>
            </div>
            <div class="mb-4">
                <input type="text" id="friendNameInput" class="w-full p-3 border border-gray-200 rounded-xl mb-4" placeholder="Enter Your Name...">
                <button onclick="startFriendQuiz()" class="w-full btn-green py-3 rounded-xl font-bold">Start Quiz</button>
            </div>
        </section>

        <section id="step5" class="hidden-section text-center">
            <h2 class="text-3xl font-bold mb-2">Score</h2>
            <div id="finalScore" class="text-6xl font-bold text-green-600 mb-4">0/10</div>
            <p id="scoreMsg" class="text-gray-500 mb-8">Not bad!</p>
            <button onclick="location.href=location.pathname" class="w-full btn-green py-4 rounded-xl font-bold">Create Your Own Quiz üöÄ</button>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLQcsbwlu3pF2RdUluFC2nKmObkpR6FOM",
            authDomain: "golpo-kotha-97625.firebaseapp.com",
            projectId: "golpo-kotha-97625",
            storageBucket: "golpo-kotha-97625.firebasestorage.app",
            messagingSenderId: "2490998669",
            appId: "1:2490998669:web:0ed037a3c9d5ed593827c4",
            measurementId: "G-CN7S2Q1K7Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make functions global
        window.db = db;
        window.fs = { doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot };
    </script>

    <script>
        const translations = {
            en: {
                welcome: "Create Your Friendship Quiz! üêº", sub: "See who knows you best!",
                name: "Enter Your Name:", gender: "Select Your Avatar:", start: "Continue ‚Üí",
                qNum: "Question", skip: "Skip this question ‚ûî", ready: "Quiz is Ready!",
                copy: "Copy Link üìã", friendHead: "How well do you know", scores: "Recent Scores",
                createOwn: "Create Your Own Quiz üöÄ",
                questions: [
                    { q: "Quick to anger? üí¢", o: ["Always", "Rarely", "Depends", "Never"] },
                    { q: "Favorite color? üé®", o: ["Black", "White", "Blue", "Red"] },
                    { q: "Most used app? üì±", o: ["Facebook", "Instagram", "YouTube", "TikTok"] },
                    { q: "Favorite food? üçî", o: ["Kacchi", "Burger", "Pizza", "Pasta"] },
                    { q: "Tea or Coffee? ‚òï", o: ["Tea", "Coffee", "Both", "None"] }
                ]
            },
            bn: {
                welcome: "‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶§‡ßç‡¶¨‡ßá‡¶∞ ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßã! üêº", sub: "‡¶¶‡ßá‡¶ñ‡¶ø ‡¶ï‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã ‡¶ö‡ßá‡¶®‡ßá!",
                name: "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡ßá‡¶ñ‡ßã:", gender: "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≠‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶æ‡¶ì:", start: "‡¶ö‡¶æ‡¶≤‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶ì ‚Üí",
                qNum: "‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®", skip: "‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶æ‡¶ì ‚ûî", ready: "‡¶ï‡ßÅ‡¶á‡¶ú ‡¶∞‡ßá‡¶°‡¶ø!",
                copy: "‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßã üìã", friendHead: "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶§‡¶ü‡ßÅ‡¶ï‡ßÅ ‡¶ö‡ßá‡¶®‡ßã", scores: "‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°",
                createOwn: "‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßã üöÄ",
                questions: [
                    { q: "‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶ñ‡ßÅ‡¶¨ ‡¶§‡¶æ‡ßú‡¶æ‡¶§‡¶æ‡ßú‡¶ø ‡¶∞‡ßá‡¶ó‡ßá ‡¶Ø‡¶æ‡¶á? üí¢", o: ["‡¶π‡ßç‡¶Ø‡¶æ‡¶Å", "‡¶®‡¶æ", "‡¶Æ‡¶æ‡¶ù‡ßá ‡¶Æ‡¶æ‡¶ù‡ßá", "‡¶ú‡¶æ‡¶®‡¶ø ‡¶®‡¶æ"] },
                    { q: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶∞‡¶Ç ‡¶ï‡ßã‡¶®‡¶ü‡¶ø? üé®", o: ["‡¶ï‡¶æ‡¶≤‡ßã", "‡¶∏‡¶æ‡¶¶‡¶æ", "‡¶®‡ßÄ‡¶≤", "‡¶≤‡¶æ‡¶≤"] },
                    { q: "‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø? üì±", o: ["Facebook", "Instagram", "YouTube", "TikTok"] },
                    { q: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡¶ü‡¶ø? üçî", o: ["‡¶ï‡¶æ‡¶ö‡ßç‡¶ö‡¶ø ‡¶¨‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶®‡¶ø", "‡¶´‡ßÅ‡¶ö‡¶ï‡¶æ", "‡¶ñ‡¶ø‡¶ö‡ßÅ‡ßú‡¶ø", "‡¶¨‡¶æ‡¶∞‡ßç‡¶ó‡¶æ‡¶∞"] },
                    { q: "‡¶ö‡¶æ ‡¶®‡¶æ‡¶ï‡¶ø ‡¶ï‡¶´‡¶ø? ‚òï", o: ["‡¶∞‡¶ô ‡¶ö‡¶æ", "‡¶¶‡ßÅ‡¶ß ‡¶ö‡¶æ", "‡¶ï‡¶´‡¶ø", "‡¶ï‡ßã‡¶®‡¶ü‡¶ø‡¶á ‡¶®‡¶æ"] }
                ]
            }
        };

        let currentLang = 'en';
        let userProfile = { name: '', gender: '', avatar: '', answers: [] };
        let quizPool = [];
        let decodedQuizData = null;
        let friendCurrentQIdx = 0;
        let scoreCounter = 0;

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const quizId = params.get('id');
            if (quizId) {
                checkFirebaseReady(quizId);
            } else {
                setupLanguage('en');
            }
        };

        function setupLanguage(code) {
            currentLang = code;
            const t = translations[code];
            document.getElementById('welcomeTitle').innerText = t.welcome;
            document.getElementById('welcomeSub').innerText = t.sub;
            document.getElementById('labelName').innerText = t.name;
            document.getElementById('labelGender').innerText = t.gender;
            quizPool = [...t.questions].sort(() => Math.random() - 0.5);
        }

        function selectAvatar(gender, el) {
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('avatar-selected'));
            el.classList.add('avatar-selected');
            userProfile.gender = gender;
            userProfile.avatar = el.querySelector('.text-4xl').innerText;
        }

        function startQuizCreation() {
            userProfile.name = document.getElementById('userName').value;
            if (!userProfile.name || !userProfile.gender) return alert("Please fill details");
            showSection('step2');
            document.getElementById('creatorNameDisplay').innerText = userProfile.name;
            renderCreatorQuestion();
        }

        function renderCreatorQuestion() {
            if (userProfile.answers.length >= 5) { // Reduced to 5 for testing
                saveToFirebase();
                return;
            }
            const q = quizPool[0];
            document.getElementById('qCount').innerText = `${translations[currentLang].qNum} ${userProfile.answers.length + 1}/5`;
            document.getElementById('currentQuestion').innerText = q.q;
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            q.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 border-2 border-gray-100 rounded-xl hover:border-green-500 hover:bg-green-50 text-left font-medium";
                btn.innerText = opt;
                btn.onclick = () => {
                    userProfile.answers.push({ q: q.q, a: idx });
                    quizPool.shift();
                    renderCreatorQuestion();
                };
                grid.appendChild(btn);
            });
        }

        async function saveToFirebase() {
            const quizId = "q_" + Date.now();
            try {
                await window.fs.setDoc(window.fs.doc(window.db, "quizzes", quizId), {
                    creatorName: userProfile.name,
                    avatar: userProfile.avatar,
                    answers: userProfile.answers,
                    results: [],
                    lang: currentLang
                });
                const url = `${window.location.origin}${window.location.pathname}?id=${quizId}`;
                document.getElementById('shareLink').value = url;
                showSection('step3');
                listenToResults(quizId);
            } catch (e) { console.error(e); }
        }

        async function checkFirebaseReady(id) {
            // Wait for firebase to load
            const check = setInterval(async () => {
                if (window.db) {
                    clearInterval(check);
                    const docSnap = await window.fs.getDoc(window.fs.doc(window.db, "quizzes", id));
                    if (docSnap.exists()) {
                        decodedQuizData = docSnap.data();
                        currentLang = decodedQuizData.lang || 'en';
                        showSection('step4');
                        document.getElementById('friendAvatar').innerText = decodedQuizData.avatar;
                        document.getElementById('friendWelcome').innerText = `${translations[currentLang].friendHead} ${decodedQuizData.creatorName}?`;
                    }
                }
            }, 500);
        }

        function startFriendQuiz() {
            if (!document.getElementById('friendNameInput').value) return alert("Enter Name");
            showSection('step2');
            document.getElementById('skipBtn').classList.add('hidden');
            renderFriendQuestion();
        }

        function renderFriendQuestion() {
            const qData = decodedQuizData.answers[friendCurrentQIdx];
            document.getElementById('qCount').innerText = `${translations[currentLang].qNum} ${friendCurrentQIdx + 1}/5`;
            document.getElementById('currentQuestion').innerText = qData.q;
            
            const originalQ = translations[currentLang].questions.find(item => item.q === qData.q);
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            originalQ.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 border-2 border-gray-100 rounded-xl hover:border-green-500 hover:bg-green-50 text-left font-medium";
                btn.innerText = opt;
                btn.onclick = async () => {
                    if (idx === qData.a) scoreCounter++;
                    friendCurrentQIdx++;
                    if (friendCurrentQIdx < 5) renderFriendQuestion();
                    else submitFriendScore();
                };
                grid.appendChild(btn);
            });
        }

        async function submitFriendScore() {
            const quizId = new URLSearchParams(window.location.search).get('id');
            const fname = document.getElementById('friendNameInput').value;
            await window.fs.updateDoc(window.fs.doc(window.db, "quizzes", quizId), {
                results: window.fs.arrayUnion({ name: fname, score: scoreCounter })
            });
            showSection('step5');
            document.getElementById('finalScore').innerText = `${scoreCounter}/5`;
        }

        function listenToResults(id) {
            window.fs.onSnapshot(window.fs.doc(window.db, "quizzes", id), (doc) => {
                const data = doc.data();
                const container = document.getElementById('leaderboardEntries');
                container.innerHTML = (data.results || []).reverse().map(r => `
                    <div class="flex justify-between bg-gray-50 p-2 rounded">
                        <span class="font-semibold">${r.name}</span>
                        <span class="text-green-600 font-bold">${r.score}/5</span>
                    </div>
                `).join('') || "No one yet.";
            });
        }

        function copyLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            alert("Copied!");
        }

        function showSection(id) {
            ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(s => document.getElementById(s).classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
        }

        function skipQuestion() {
            quizPool.shift();
            renderCreatorQuestion();
        }

        document.getElementById('langSwitcher').addEventListener('change', (e) => setupLanguage(e.target.value));
    </script>
</body>
</html>
